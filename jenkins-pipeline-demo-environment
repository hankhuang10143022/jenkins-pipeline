pipeline {
  agent { label 'ansible-controller' }

    environment {                               //此pipeline為有設環境變數的版本(還未接webhook版本)
        // ===== 基本設定 =====
        IMAGE_NAME = "frontend"   //自己取的image名稱，會用為image命名標記用
        IMAGE_TAG  = "main"    //這邊會用gitlab的branch或tag，方便為image命名標記用
        REPO_NAME  = "602708357953.dkr.ecr.ap-northeast-1.amazonaws.com"  //docker registry 我們是用AWS的ECR
      
        // ===== Target Host =====
        TARGET_USER    = "ubuntu"  //Target Host的使用者
        TARGET_HOST_IP = "192.168.5.14"    //Target Host的ip
        SSH_CREDENTIAL_ID = "192.168.5.14" //SSH Agent private key 設定時,此案例id值剛好是IP
      
         // ===== Build Vars =====
         //當前日期，通常不會動它，目的為將我們的image做時間戳記
         CURRENT_DATE = "${new Date().format('yyyyMMdd')}"  
         //為image命名目的為上傳至docker registry，格式:ECR-URL/image名稱:專案所在分支或tag(Gitlab)-日期-pipeline編號
         DOCKER_IMAGE = "${REPO_NAME}/${IMAGE_NAME}:${IMAGE_TAG}-${CURRENT_DATE}-${BUILD_NUMBER}"
      
     }
  
  
  stages {
      
    stage('test gitlab') {
      steps {
        git branch: "${IMAGE_TAG}", 
        credentialsId: 'gitlab', 
        url: 'http://192.168.5.74/root/demo.git'
      }
    }
    
    stage('check file') {
      steps {
          sh 'pwd'
          sh 'ls -alt'
        
      }
    }
    
    stage("build image") {
          steps {
                  sh '''
                     echo "Build image: ${DOCKER_IMAGE}"
                     
                     docker build -t ${DOCKER_IMAGE} .
                     '''                     
              }
          }
    
    
       stage("write .env") {   //,env環境變數為替換docker-compose.yaml的image使用
            steps {
                     sh 'echo DOCKER_IMAGE=${DOCKER_IMAGE} > .env'
                        
                     sh 'ls -alt && cat .env'
                        
                  }
            }
            
        stage("login ECR") {  //ansible 主機需登入ECR 
          steps {
                  withAWS(credentials: 'ecr-permit', region: 'ap-northeast-1') {
                  sh '''
                      aws ecr get-login-password | docker login --username AWS --password-stdin ${REPO_NAME}
                     ''' 
                  }
              }
          }
          
          stage("push image") {  //為了將images 推至ECR
              steps{
                  //將image推到ECR
                  sh 'docker push ${DOCKER_IMAGE}'
                   
                  //清理image
                  sh'docker rmi ${DOCKER_IMAGE}'
              }
          }
          
          stage('check aws cli in target host') {
             steps {
                 ansiblePlaybook become: true, 
                 disableHostKeyChecking: true, 
                 installation: 'ansible',
                 inventory: 'ansible/inventory',
                 playbook: 'ansible/aws-cli-ubuntu.yaml'
             }
        }
        
        
          stage('target host login ECR') {
            steps {
               withAWS(credentials: 'ecr-permit', region: 'ap-northeast-1') {
                   sshagent([env.SSH_CREDENTIAL_ID]) {   //ssh agent變數用 [env.變數名稱] 來表示
                     sh '''
                        # 在 Jenkins agent 取得 ECR token
                        TOKEN=$(aws ecr get-login-password --region ap-northeast-1)
                        
                        # 將 token 傳給 targeted host 做 docker login
                        ssh  ${TARGET_USER}@${TARGET_HOST_IP}  -o StrictHostKeyChecking=no "
                        echo '$TOKEN' | docker login --username AWS --password-stdin ${REPO_NAME}
                        "
                        '''
                   }
               }
            }
         }
         
         stage('depolying') {
           steps {
               ansiblePlaybook become: true, 
               disableHostKeyChecking: true, 
               installation: 'ansible',
               inventory: 'ansible/inventory',
               playbook: 'ansible/docker-deploy.yaml'
           }
             
         }
    
    
   }
}
